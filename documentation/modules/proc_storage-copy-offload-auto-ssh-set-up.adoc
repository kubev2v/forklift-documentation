// Module included in the following assemblies:
//
// * documentation/doc-Planning_your_migration/assemblies/assembly_migrating-from-vmware.adoc

:_mod-docs-content-type: PROCEDURE
[id="proc_storage-copy-offload-auto-ssh-set-up_{context}"]
= Setting up storage copy offload by using automatically generated SSH keys

[role="_abstract"]
By default, when you use the SSH method for setting up storage copy migrations, SSH keys are automatically generated when you create or update a relevant vSphere provider.

These keys have the following characteristics:

- 2048-bit RSA keys
- Stored in separate Kubernetes Secrets in the provider's namespace
- Automatically injected into migration pods as needed

SSH keys are stored in secrets with predictable names based on the name of your vSphere provider:

[cols="1,1,1",options="header"]
.Patterns of SSH secret names
|===
| Secret type
| Naming pattern
| Contains

| Private key
| `offload-ssh-keys-{provider-name}-private`
| `private-key`: RSA private key in PEM format

| Public key
| `offload-ssh-keys-{proider-name}-public`
| `public-key: SSH public key in authorized_keys format
|===

Example: For a provider with the name `vcenter-example`, the secrets would be `offload-ssh-keys-vcenter-example-private` and `offload-ssh-keys-vcenter-example-public`.

.Prerequisites

* Ensure that SSH traffic is permitted from the {virt} network to the ESXis.

.Procedure

. Configure the SSH clone method in your `Provider` CR by setting `settings:exsiCloneMethod` to `"ssh"`.
+
.Example Provider CR
[source,yaml,subs="attributes+"]
----
apiVersion: forklift.konveyor.io/v1beta1
kind: Provider
metadata:
  name: my-vsphere-provider
  namespace: openshift-mtv
spec:
  type: vsphere
  url: https://vcenter.example.com
  secret:
    name: vsphere-credentials
    namespace: openshift-mtv
  settings:
    esxiCloneMethod: "ssh" 
----
+
. Find the SSH secrets for your vSphere Provider by running one of the following commands:

.. List all SSH key secrets in the provider's namespace by running the following command:
+
[source,terminal]
----
$ oc get secrets -l app.kubernetes.io/component=ssh-keys -n openshift-mtv
----
+
.. View a specific private or public key secret by running the following command:
+
[source,terminal]
----
$ oc get secret <name_of_private_or_public_key> -o yaml -n openshift-mtv
----
+
. Optional: If needed, you can replace an auto-generated key pair by running the following command:
+
[source,terminal]
----
$ ssh-keygen -t rsa -b 4096 -f custom_esxi_key -N ""
----
+
This is a simpler procedure than manually generating the key pair, as described in TBD.

. Optional: If needed, you can replace either a private key secret or a public key secret by running one of the following commands:

.. Replace a private key secret by running the following command:
+
[source,terminal]
----
$ oc create secret generic <name_of_private_key> \
  --from-file=private-key=custom_esxi_key \
  --dry-run=client -o yaml | oc replace -f - -n openshift-mtv
----
+
.. Replace a public key secret by running the following command:
+
[source,terminal]
----
$ oc create secret generic <name of public key> \
  --from-file=public-key=custom_esxi_key.pub \
  --dry-run=client -o yaml | oc replace -f - -n openshift-mtv
----
+
. Optional: Configure the SSH timeout by adding it to your provider secret, which is the main storage credentials secret, by running the following command:
+
[source,terminal]
----
$ oc patch secret <provider_credentials> -p '{"data":{"SSH_TIMEOUT_SECONDS":"'$(echo -n "60" | base64)'"}}' -n <provider_namespace>
----

