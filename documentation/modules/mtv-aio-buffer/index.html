<!DOCTYPE html>
<html lang="en-US">
  <head>

    
    <meta charset="UTF-8">
    
    <title>Forklift Documentation</title>
    <!-- # Opengraph protocol properties: https://ogp.me/ -->
    <meta name="author" content="Forklift documentation team" >
    <meta property="og:type" content="article" >
    <meta name="twitter:card" content="summary">
    <meta name="keywords" content="" >
    <meta property="og:type" content="website">
    <meta property="og:image" content="">
    <meta property="og:article:author" content="Forklift documentation team" >
    <meta property="og:article:published_time" content="2025-03-02 18:49:36 -0600" >
    <meta name="twitter:title" content="Forklift Documentation">
    <meta name="twitter:description" content="Migrating VMware virtual machines to KubeVirt">

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Forklift Documentation | Migrating VMware virtual machines to KubeVirt</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Forklift Documentation" />
<meta name="author" content="Forklift documentation team" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Migrating VMware virtual machines to KubeVirt" />
<meta property="og:description" content="Migrating VMware virtual machines to KubeVirt" />
<meta property="og:site_name" content="Forklift Documentation" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Forklift Documentation" />
<meta name="twitter:site" content="@konveyor_io" />
<meta name="twitter:creator" content="@Forklift documentation team" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Forklift documentation team"},"description":"Migrating VMware virtual machines to KubeVirt","headline":"Forklift Documentation","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/img/forklift-logo-darkbg.svg"},"name":"Forklift documentation team"},"url":"/documentation/modules/mtv-aio-buffer/"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <link rel="shortcut icon" type="image/png" href="images/favicon.png">
  </head>
  <body>
    <header class="page-header">
        
          <a href="/"><img src="/assets/img/forklift-logo-darkbg.svg" alt="Forklift Documentation" width="200" /></a><br>
        
      
        <a href="https://github.com/konveyor/forklift-documentation" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="mtv-aio-buffer_forklift">Increasing asynchronous I/O (AIO) sizes and buffer counts for NBD transport mode</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document describes how to change NBD transport NFC parameters for increased migration performance when using the Forklift product.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="title">Cold Migration Only</div>
<div class="paragraph">
<p>Using AIO buffering is only suitable for Cold Migration use cases.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Disable AIO settings before initializing Warm Migration. For more details, see <a href="#mtv-disable-aio-buffer_mtv">Disabling AIO Buffer Configuration</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional information</div>
<ul>
<li>
<p><a href="https://docs.vmware.com/en/VMware-vSphere/7.0/vsphere-vddk-programming-guide/GUID-5D166ED1-7205-4110-8D72-0C51BB63CC3D.html">Best Practices for NBD Transport</a></p>
</li>
<li>
<p><a href="https://forums.veeam.com/vmware-vsphere-f24/solution-for-poor-nbd-performance-t93084.html">Solution for poor NBD performance</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mtv-aio-buffer-key-findings_forklift">Key findings</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The best migration performance was achieved by migrating using multiple VMs (10) on a single ESXi host with the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>VixDiskLib.nfcAio.Session.BufSizeIn64KB=16</code></p>
</li>
<li>
<p><code>vixDiskLib.nfcAio.Session.BufCount=4</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>The following improvements were noted when using AIO buffer (Asynchronous Buffer Counts) settings:</p>
<div class="ulist">
<ul>
<li>
<p>Migration time was reduced by <strong>31.1%</strong>, from <code>0:24:32</code> to <code>0:16:54</code>.</p>
</li>
<li>
<p>Read rate was increased from <code>347.83 MB/s</code> to <code>504.93 MB/s</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>There was no significant improvement observed when using AIO buffer settings with a single VM.</p>
</li>
<li>
<p>There was no significant improvement observed when using AIO buffer settings with multiple VMs from multiple hosts.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mtv-enable-aio-buffer_forklift">Enabling AIO buffer configuration</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Validating Controller Pod support for AIO values</div>
<ul>
<li>
<p>Ensure that the <code>forklift-controller</code> pod in the <code>openshift-mtv</code> namespace supports the AIO buffer values.</p>
<div class="paragraph">
<p>Since the pod name prefix is dynamic, check the pod name first by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">oc get pods -n openshift-mtv | grep forklift-controller | awk '{print $1}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example output is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">forklift-controller-667f57c8f8-qllnx</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This is the pod name prefix from the example: <code>forklift-controller-667f57c8f8-qllnx</code></p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Check the environment variables of the pod by running:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">oc get pod forklift-controller-667f57c8f8-qllnx -n openshift-mtv -o yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check for the following lines in the output:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">...
\- name: VIRT\_V2V\_EXTRA\_ARGS
\- name: VIRT\_V2V\_EXTRA\_CONF\_CONFIG\_MAP
...</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Editing ForkliftController Configuration</div>
<ul>
<li>
<p>In the <code>openshift-mtv namespace</code>, edit the <code>ForkliftController</code> object to include the AIO buffer values by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">oc edit forkliftcontroller -n openshift-mtv</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following under the spec section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">virt_v2v_extra_args: "--vddk-config /mnt/extra-v2v-conf/input.conf"
virt_v2v_extra_conf_config_map: "perf"</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Creating a ConfigMap named <code>perf</code></div>
<ul>
<li>
<p>Create the required ConfigMap using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">oc -n openshift-mtv create cm perf</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Preparing the ConfigMap content</div>
<ul>
<li>
<p>Convert the desired buffer configuration values to Base64. For example, for 16/4:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">echo -e "VixDiskLib.nfcAio.Session.BufSizeIn64KB=16\nvixDiskLib.nfcAio.Session.BufCount=4" | base64</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">Vml4RGlza0xpYi5uZmNBaW8uU2Vzc2lvbi5CdWZTaXplSW42NEtCPTE2CnZpeERpc2tMaWIubmZjQWlvLlNlc3Npb24uQnVmQ291bnQ9NAo=</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Editing the ConfigMap</div>
<ul>
<li>
<p>Update the perf ConfigMap with the Base64 string under the <code>binaryData</code> section, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">apiVersion: v1
kind: ConfigMap
binaryData:
  input.conf: Vml4RGlza0xpYi5uZmNBaW8uU2Vzc2lvbi5CdWZTaXplSW42NEtCPTE2CnZpeERpc2tMaWIubmZjQWlvLlNlc3Npb24uQnVmQ291bnQ9NAo=
metadata:
  name: perf
  namespace: openshift-mtv</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Restarting the Forklift Controller Pod</div>
<ul>
<li>
<p>Restart the forklift-controller pod to apply the new configuration.</p>
</li>
<li>
<p>Ensure the <code>VIRT_V2V_EXTRA_ARGS</code> environment variable reflects the updated settings.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Verifying migration logs</div>
<ul>
<li>
<p>Run a migration plan and check the logs of the migration pod. Confirm that the AIO buffer settings are passed as parameters, particularly the <code>--vddk-config value</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">exec: /usr/bin/virt-v2v … --vddk-config /mnt/extra-v2v-conf/input.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sample log excerpt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">Buffer size calc for 16 value:
(16 * 64 * 1024 = 1048576)
nbdkit: vddk[1]: debug: [NFC VERBOSE] NfcAio_OpenSession:
Opening an AIO session.
nbdkit: vddk[1]: debug: [NFC INFO] NfcAioInitSession:
Disabling
read-ahead buffer since the AIO buffer size of 1048576 is &gt;=
the read-ahead buffer size of 65536. Explicitly setting flag
'`NFC_AIO_SESSION_NO_NET_READ_AHEAD`'
nbdkit: vddk[1]: debug: [NFC VERBOSE] NfcAioInitSession: AIO Buffer Size is 1048576
nbdkit: vddk[1]: debug: [NFC VERBOSE] NfcAioInitSession: AIO Buffer
Count is 4</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The above logs were when using <code>debug_level = 4</code></p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Inspecting ConfigMap values Content are in the Migration Pod</div>
<ul>
<li>
<p>Log in to the migration pod and verify the buffer settings using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">cat /mnt/extra-v2v-conf/input.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example output is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">VixDiskLib.nfcAio.Session.BufSizeIn64KB=16
vixDiskLib.nfcAio.Session.BufCount=4</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Enabling Debugging (optional)</div>
<ul>
<li>
<p>To enable debug logs, convert the configuration to Base64, including a high log level:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">echo -e
"`VixDiskLib.nfcAio.Session.BufSizeIn64KB=16\nVixDiskLib.nfcAio.Session.BufCount=4\nVixDiskLib.nfc.LogLevel=4`"
| base64</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Adding a high log level will degrade performance and is for debugging purposes only.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mtv-disable-aio-buffer_forklift">Disabling AIO Buffer Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To disable the AIO buffer configuration, complete the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Edit the ForkliftController Object: Remove the previously added lines from the spec section in the ForkliftController object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">oc edit forkliftcontroller -n openshift-mtv</code></pre>
</div>
</div>
</li>
<li>
<p>Remove the following lines:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">virt_v2v_extra_args: "`–vddk-config /mnt/extra-v2v-conf/input.conf`"
virt_v2v_extra_conf_config_map: "`perf`"</code></pre>
</div>
</div>
</li>
<li>
<p>Delete the ConfigMap: Remove the perf ConfigMap that was created earlier:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terminal" data-lang="terminal">oc delete cm perf -n openshift-mtv</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the Forklift Controller Pod (Optional).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If needed, ensure the changes take effect by restarting the forklift-controller pod.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mtv-aio-buffer-key-requirements_forklift">Key requirements for AIO Buffer (Asynchronous Buffer Counts) support</h2>
<div class="sectionbody">
<div class="paragraph">
<div class="title">VDDK and vSphere Versions</div>
<p>Support is based upon tests performed using the following versions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>vSphere : 7.0.3</p>
</li>
<li>
<p>VDDK : 7.0.3</p>
</li>
<li>
<p>For other VDDK and vSphere versions, please check the AIO buffer support in the <a href="https://docs.vmware.com/">official VMware documentation</a>.</p>
</li>
</ul>
</div>
</div>
</div>

      <footer class="site-footer">
        
          <span class="site-footer-owner"><p align="center"><a href="https://github.com/konveyor/forklift-documentation">forklift-documentation</a> is maintained by <a href="https://github.com/konveyor">konveyor</a>.</p></span>
        
      </footer>
    </main>
  </body>
</html>
